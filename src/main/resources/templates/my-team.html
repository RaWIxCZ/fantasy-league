<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <title>Můj Tým - Sestava</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/rink.css" rel="stylesheet">
</head>

<body class="bg-light">

  <div th:replace="~{fragments :: nav}"></div>

  <div class="container-fluid mt-4">
    <div class="row px-4">

      <div class="col-12 col-xl-8"> <!-- Změna na 8 (bylo 9) -->
        <div class="d-flex justify-content-evenly flex-wrap">

          <!-- 1. FORMACE + BRANKÁŘ -->
          <div class="rink-wrapper">
            <h5 class="text-center mb-2 text-uppercase fw-bold text-secondary">1. Formace</h5>
            <div class="rink-container shadow relative">
              <div id="line-1-container">
                <!-- ÚTOČNÍCI -->
                <div id="slot-L1_LW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="LW" data-slot-name="L1_LW"
                  th:classappend="${lineup['L1_LW'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L1_LW'] == null}">Ú</small>
                  <div th:if="${lineup['L1_LW'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L1_LW'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L1_LW'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L1_LW'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L1_LW'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <div id="slot-L1_C" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="C" data-slot-name="L1_C" th:classappend="${lineup['L1_C'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L1_C'] == null}">Ú</small>
                  <div th:if="${lineup['L1_C'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L1_C'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L1_C'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L1_C'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L1_C'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <div id="slot-L1_RW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="RW" data-slot-name="L1_RW"
                  th:classappend="${lineup['L1_RW'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L1_RW'] == null}">Ú</small>
                  <div th:if="${lineup['L1_RW'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L1_RW'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L1_RW'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L1_RW'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L1_RW'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <!-- OBRÁNCI -->
                <div id="slot-L1_LD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="LD" data-slot-name="L1_LD"
                  th:classappend="${lineup['L1_LD'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L1_LD'] == null}">O</small>
                  <div th:if="${lineup['L1_LD'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L1_LD'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L1_LD'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L1_LD'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L1_LD'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <div id="slot-L1_RD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="RD" data-slot-name="L1_RD"
                  th:classappend="${lineup['L1_RD'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L1_RD'] == null}">O</small>
                  <div th:if="${lineup['L1_RD'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L1_RD'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L1_RD'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L1_RD'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L1_RD'].player.lastName}">Jméno</div>
                  </div>
                </div>
              </div>

              <!-- BRANKÁŘ (Pouze u 1. formace) -->
              <div id="slot-GK" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                data-position="GK" data-slot-name="GK" th:classappend="${lineup['GK'] != null} ? 'occupied' : ''">
                <small class="text-muted" th:if="${lineup['GK'] == null}">G</small>
                <div th:if="${lineup['GK'] != null}" class="ice-player-token" draggable="true"
                  ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['GK'].player.id}"
                  th:data-roster-id="'roster-player-' + ${lineup['GK'].player.id}">
                  <button class="remove-btn" onclick="removePlayer(this)">×</button>
                  <img th:src="${lineup['GK'].player.headshotUrl}" class="ice-player-img"
                    onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                  <div class="ice-player-name" th:text="${lineup['GK'].player.lastName}">Jméno</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 2. FORMACE -->
          <div class="rink-wrapper">
            <h5 class="text-center mb-2 text-uppercase fw-bold text-secondary">2. Formace</h5>
            <div class="rink-container shadow relative">
              <div id="line-2-container">
                <!-- ÚTOČNÍCI -->
                <div id="slot-L2_LW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="LW" data-slot-name="L2_LW"
                  th:classappend="${lineup['L2_LW'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L2_LW'] == null}">Ú</small>
                  <div th:if="${lineup['L2_LW'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L2_LW'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L2_LW'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L2_LW'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L2_LW'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <div id="slot-L2_C" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="C" data-slot-name="L2_C" th:classappend="${lineup['L2_C'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L2_C'] == null}">Ú</small>
                  <div th:if="${lineup['L2_C'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L2_C'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L2_C'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L2_C'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L2_C'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <div id="slot-L2_RW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="RW" data-slot-name="L2_RW"
                  th:classappend="${lineup['L2_RW'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L2_RW'] == null}">Ú</small>
                  <div th:if="${lineup['L2_RW'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L2_RW'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L2_RW'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L2_RW'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L2_RW'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <!-- OBRÁNCI -->
                <div id="slot-L2_LD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="LD" data-slot-name="L2_LD"
                  th:classappend="${lineup['L2_LD'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L2_LD'] == null}">O</small>
                  <div th:if="${lineup['L2_LD'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L2_LD'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L2_LD'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L2_LD'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L2_LD'].player.lastName}">Jméno</div>
                  </div>
                </div>

                <div id="slot-L2_RD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
                  data-position="RD" data-slot-name="L2_RD"
                  th:classappend="${lineup['L2_RD'] != null} ? 'occupied' : ''">
                  <small class="text-muted" th:if="${lineup['L2_RD'] == null}">O</small>
                  <div th:if="${lineup['L2_RD'] != null}" class="ice-player-token" draggable="true"
                    ondragstart="dragToken(event)" th:id="'ice-token-' + ${lineup['L2_RD'].player.id}"
                    th:data-roster-id="'roster-player-' + ${lineup['L2_RD'].player.id}">
                    <button class="remove-btn" onclick="removePlayer(this)">×</button>
                    <img th:src="${lineup['L2_RD'].player.headshotUrl}" class="ice-player-img"
                      onerror="this.onerror=null; this.src='https.nhle.com/mugs/nhl/default-skater.png';">
                    <div class="ice-player-name" th:text="${lineup['L2_RD'].player.lastName}">Jméno</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="col-12 col-xl-4">
        <div class="card shadow h-100">
          <div class="card-header bg-dark text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Střídačka</h5>
            </div>
            <div class="mt-2">
              <a th:if="${!isTeamFull}" href="/players" class="btn btn-primary w-100 btn-sm">+ Draftovat další hráče</a>
              <button th:if="${isTeamFull}" class="btn btn-secondary w-100 btn-sm" disabled>Dosažena maximální kapacita
                týmu</button>
            </div>
          </div>
          <div class="card-body roster-list p-2">

            <!-- Útočníci -->
            <h6 class="roster-category-header">Útočníci - <span
                th:text="${forwardsCount} + '/' + ${maxForwards}">0/11</span></h6>
            <div th:each="player : ${sortedForwards}" class="roster-card-modern" draggable="true"
              ondragstart="drag(event)" th:id="'roster-player-' + ${player.id}"
              th:classappend="(${activePlayerSlots.containsKey(player.id)} ? 'is-assigned' : '') + (${player.injured} ? ' is-injured' : '')"
              th:data-current-slot="${activePlayerSlots.get(player.id)}" th:data-id="${player.id}"
              th:data-name="${player.lastName}" th:data-pos="${player.position}" th:data-img="${player.headshotUrl}"
              th:attr="data-injured=${player.injured}">
              <div class="assigned-overlay" th:if="${activePlayerSlots.containsKey(player.id)}">
                <span th:if="${#strings.contains(activePlayerSlots.get(player.id), 'L1')}">Nasazen v 1. formaci</span>
                <span th:if="${#strings.contains(activePlayerSlots.get(player.id), 'L2')}">Nasazen v 2. formaci</span>
              </div>
              <div class="injured-overlay" th:if="${player.injured}">
                <span>Zraněný</span>
              </div>
              <div class="player-info-left">
                <img th:src="${player.headshotUrl}" alt="Foto" class="player-img-small"
                  onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                <div class="player-details">
                  <h6 th:text="${player.firstName.charAt(0) + '. ' + player.lastName}">Jméno</h6>
                  <div class="player-subtext">
                    <span th:text="${player.teamName}">Tým</span> •
                    <span th:text="${player.position}" class="text-primary">POS</span>
                  </div>
                </div>
              </div>
              <div class="player-stats-right">
                <div class="stat-box">
                  <span class="stat-value" th:text="${player.seasonGoals}">0</span>
                  <span class="stat-label">G</span>
                </div>
                <div class="stat-box">
                  <span class="stat-value" th:text="${player.seasonAssists}">0</span>
                  <span class="stat-label">A</span>
                </div>
                <div class="stat-box">
                  <span class="stat-value" th:text="${player.seasonPlusMinus}">0</span>
                  <span class="stat-label">+/-</span>
                </div>
                <div class="stat-box primary">
                  <span class="stat-value"
                    th:text="${#numbers.formatDecimal(player.averageFantasyPoints, 1, 2)}">0.00</span>
                  <span class="stat-label">Ø B</span>
                </div>
              </div>
            </div>

            <!-- Obránci -->
            <h6 class="roster-category-header">Obránci - <span
                th:text="${defensemenCount} + '/' + ${maxDefensemen}">0/7</span></h6>
            <div th:each="player : ${sortedDefensemen}" class="roster-card-modern" draggable="true"
              ondragstart="drag(event)" th:id="'roster-player-' + ${player.id}"
              th:classappend="(${activePlayerSlots.containsKey(player.id)} ? 'is-assigned' : '') + (${player.injured} ? ' is-injured' : '')"
              th:data-current-slot="${activePlayerSlots.get(player.id)}" th:data-id="${player.id}"
              th:data-name="${player.lastName}" th:data-pos="${player.position}" th:data-img="${player.headshotUrl}"
              th:attr="data-injured=${player.injured}">
              <div class="assigned-overlay" th:if="${activePlayerSlots.containsKey(player.id)}">
                <span th:if="${#strings.contains(activePlayerSlots.get(player.id), 'L1')}">Nasazen v 1. formaci</span>
                <span th:if="${#strings.contains(activePlayerSlots.get(player.id), 'L2')}">Nasazen v 2. formaci</span>
              </div>
              <div class="injured-overlay" th:if="${player.injured}">
                <span>Zraněný</span>
              </div>
              <div class="player-info-left">
                <img th:src="${player.headshotUrl}" alt="Foto" class="player-img-small"
                  onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                <div class="player-details">
                  <h6 th:text="${player.firstName.charAt(0) + '. ' + player.lastName}">Jméno</h6>
                  <div class="player-subtext">
                    <span th:text="${player.teamName}">Tým</span> •
                    <span th:text="${player.position}" class="text-primary">POS</span>
                  </div>
                </div>
              </div>
              <div class="player-stats-right">
                <div class="stat-box">
                  <span class="stat-value" th:text="${player.seasonGoals}">0</span>
                  <span class="stat-label">G</span>
                </div>
                <div class="stat-box">
                  <span class="stat-value" th:text="${player.seasonAssists}">0</span>
                  <span class="stat-label">A</span>
                </div>
                <div class="stat-box">
                  <span class="stat-value" th:text="${player.seasonPlusMinus}">0</span>
                  <span class="stat-label">+/-</span>
                </div>
                <div class="stat-box primary">
                  <span class="stat-value"
                    th:text="${#numbers.formatDecimal(player.averageFantasyPoints, 1, 2)}">0.00</span>
                  <span class="stat-label">Ø B</span>
                </div>
              </div>
            </div>

            <!-- Brankáři -->
            <h6 class="roster-category-header">Brankáři - <span
                th:text="${goaliesCount} + '/' + ${maxGoalies}">0/3</span></h6>
            <div th:each="player : ${sortedGoalies}" class="roster-card-modern" draggable="true"
              ondragstart="drag(event)" th:id="'roster-player-' + ${player.id}"
              th:classappend="(${activePlayerSlots.containsKey(player.id)} ? 'is-assigned' : '') + (${player.injured} ? ' is-injured' : '')"
              th:data-current-slot="${activePlayerSlots.get(player.id)}" th:data-id="${player.id}"
              th:data-name="${player.lastName}" th:data-pos="${player.position}" th:data-img="${player.headshotUrl}"
              th:attr="data-injured=${player.injured}">
              <div class="assigned-overlay" th:if="${activePlayerSlots.get(player.id) == 'GK'}">
                <span>Nasazen v bráně</span>
              </div>
              <div class="injured-overlay" th:if="${player.injured}">
                <span>Zraněný</span>
              </div>
              <div class="player-info-left">
                <img th:src="${player.headshotUrl}" alt="Foto" class="player-img-small"
                  onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                <div class="player-details">
                  <h6 th:text="${player.firstName.charAt(0) + '. ' + player.lastName}">Jméno</h6>
                  <div class="player-subtext">
                    <span th:text="${player.teamName}">Tým</span> •
                    <span th:text="${player.position}" class="text-warning">POS</span>
                  </div>
                </div>
              </div>
              <div class="player-stats-right">
                <div class="stat-box">
                  <span class="stat-value" th:text="${#numbers.formatDecimal(player.seasonGaa, 1, 2)}">0.00</span>
                  <span class="stat-label">GAA</span>
                </div>
                <div class="stat-box">
                  <span class="stat-value" th:text="${#numbers.formatPercent(player.seasonSavePctg, 1, 1)}">.000</span>
                  <span class="stat-label">SV%</span>
                </div>
                <div class="stat-box primary">
                  <span class="stat-value"
                    th:text="${#numbers.formatDecimal(player.averageFantasyPoints, 1, 2)}">0.00</span>
                  <span class="stat-label">Ø B</span>
                </div>
              </div>
            </div>

            <div th:if="${team.players.empty}" class="text-center mt-5 text-muted">
              <p>Nemáš žádné hráče.</p>
              <a href="/players" class="btn btn-primary btn-sm">Jít na Draft</a>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Načtení CSRF tokenů (aby fungovalo ukládání)
    const csrfTokenElement = document.querySelector('meta[name="_csrf"]');
    const csrfHeaderElement = document.querySelector('meta[name="_csrf_header"]');

    const csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : null;
    const csrfHeader = csrfHeaderElement ? csrfHeaderElement.getAttribute('content') : null;

    // Přepínání formací
    function switchLine(lineNumber) {
      const line1 = document.getElementById('line-1-container');
      const line2 = document.getElementById('line-2-container');

      if (lineNumber === 1) {
        line1.style.display = 'block';
        line2.style.display = 'none';
      } else {
        line1.style.display = 'none';
        line2.style.display = 'block';
      }
    }

    function allowDrop(ev) {
      ev.preventDefault(); // NUTNÉ: Bez tohoto drop nefunguje!
    }

    function drag(ev) {
      const card = ev.target.closest('.roster-card-modern'); // Najdeme hlavní kartu
      ev.dataTransfer.setData("id", card.getAttribute("data-id"));
      ev.dataTransfer.setData("name", card.getAttribute("data-name"));
      ev.dataTransfer.setData("pos", card.getAttribute("data-pos"));
      ev.dataTransfer.setData("img", card.getAttribute("data-img"));
      ev.dataTransfer.setData("elementId", card.id);
      ev.dataTransfer.setData("dragType", "roster"); // Přidáme typ
      ev.dataTransfer.setData("is-injured", card.getAttribute("data-injured"));

      console.log("Táhnu hráče z lavičky: " + card.getAttribute("data-name"));
    }

    function dragToken(ev) {
      const token = ev.target.closest('.ice-player-token');
      const rosterCardId = token.getAttribute('data-roster-id');
      const rosterCard = document.getElementById(rosterCardId);

      ev.dataTransfer.setData("id", rosterCard.getAttribute("data-id"));
      ev.dataTransfer.setData("name", rosterCard.getAttribute("data-name"));
      ev.dataTransfer.setData("pos", rosterCard.getAttribute("data-pos"));
      ev.dataTransfer.setData("img", rosterCard.getAttribute("data-img"));
      ev.dataTransfer.setData("elementId", rosterCard.id);
      ev.dataTransfer.setData("dragType", "token"); // Přidáme typ
      ev.dataTransfer.setData("sourceSlot", token.closest('.player-slot').id); // ID slotu, odkud táhneme
      ev.dataTransfer.setData("is-injured", rosterCard.getAttribute("data-injured"));

      console.log("Táhnu hráče z ledu: " + rosterCard.getAttribute("data-name"));
    }

    function drop(ev) {
      ev.preventDefault();
      const slot = ev.target.closest('.player-slot');
      if (!slot) return;

      const isInjured = ev.dataTransfer.getData("is-injured") === 'true';
      if (isInjured) {
        if (!confirm('Tento hráč je zraněný. Opravdu ho chcete nasadit?')) {
          return;
        }
      }

      const dragType = ev.dataTransfer.getData("dragType");

      if (dragType === "roster") {
        handleRosterDrop(ev, slot);
      } else if (dragType === "token") {
        handleTokenDrop(ev, slot);
      }
    }

    function handleRosterDrop(ev, slot) {
      const playerId = ev.dataTransfer.getData("id");
      const rosterElementId = ev.dataTransfer.getData("elementId");
      const rosterCard = document.getElementById(rosterElementId);

      const targetSlotName = slot.getAttribute("data-slot-name");
      const targetGeneralPos = slot.getAttribute("data-position");
      const currentSlotName = rosterCard.getAttribute("data-current-slot");

      const playerPos = ev.dataTransfer.getData("pos");
      if (!isPositionValid(playerPos, targetGeneralPos)) {
        alert("Tento hráč nemůže hrát na pozici " + targetGeneralPos);
        return;
      }

      if (currentSlotName && currentSlotName !== targetSlotName) {
        const isLine1 = currentSlotName.includes('L1');
        const targetIsLine1 = targetSlotName.includes('L1');

        let message = "";
        if (isLine1 && !targetIsLine1) message = "Hráč je v 1. formaci. Chcete ho přesunout do 2. formace?";
        else if (!isLine1 && targetIsLine1) message = "Hráč je v 2. formaci. Chcete ho přesunout do 1. formace?";
        else message = "Opravdu chcete hráče přesunout na jinou pozici?";

        if (!confirm(message)) {
          return;
        }

        const oldSlotElement = document.getElementById('slot-' + currentSlotName);
        if (oldSlotElement) {
          const generalPos = oldSlotElement.getAttribute("data-position");
          let label = "";
          if (generalPos === 'GK') label = 'G';
          else if (['LD', 'RD', 'D'].includes(generalPos)) label = 'O';
          else label = 'Ú';

          oldSlotElement.innerHTML = `<small class="text-muted">${label}</small>`;
          oldSlotElement.classList.remove("occupied");
        }

        if (csrfToken && csrfHeader) {
          fetch('/api/lineup/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
            body: JSON.stringify({ slotName: currentSlotName })
          });
        }
      }

      if (slot.classList.contains("occupied")) {
        removePlayerFromSlot(slot);
      }

      const playerName = ev.dataTransfer.getData("name");
      const playerImg = ev.dataTransfer.getData("img");

      slot.innerHTML = `
      <div class="ice-player-token" draggable="true" ondragstart="dragToken(event)" id="ice-token-${playerId}" data-roster-id="${rosterElementId}">
        <button class="remove-btn" onclick="removePlayer(this)">×</button>
        <img src="${playerImg}" class="ice-player-img" onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
        <div class="ice-player-name">${playerName}</div>
      </div>
    `;
      slot.classList.add("occupied");

      updateRosterCardVisuals(rosterCard, targetSlotName);

      if (csrfToken && csrfHeader) {
        fetch('/api/lineup/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
          body: JSON.stringify({ playerId: playerId, slotName: targetSlotName })
        });
      }
    }

    function handleTokenDrop(ev, targetSlot) {
      const sourceSlotId = ev.dataTransfer.getData("sourceSlot");
      const sourceSlot = document.getElementById(sourceSlotId);

      if (sourceSlot.id === targetSlot.id) return; // Netahej na stejné místo

      const rosterElementId = ev.dataTransfer.getData("elementId");
      const rosterCard = document.getElementById(rosterElementId);
      const playerPos = rosterCard.getAttribute("data-pos");
      const targetGeneralPos = targetSlot.getAttribute("data-position");

      if (!isPositionValid(playerPos, targetGeneralPos)) {
        alert("Tento hráč nemůže hrát na pozici " + targetGeneralPos);
        return;
      }

      const sourceToken = sourceSlot.querySelector('.ice-player-token');
      const targetToken = targetSlot.querySelector('.ice-player-token');

      // Cílový slot je prázdný
      if (!targetToken) {
        targetSlot.innerHTML = ''; // Vyčistit text "LW 1" atd.
        targetSlot.appendChild(sourceToken);
        targetSlot.classList.add("occupied");

        // Vyčistit starý slot
        const oldPos = sourceSlot.getAttribute("data-position");
        let label = "";
        if (oldPos === 'GK') label = 'G';
        else if (['LD', 'RD', 'D'].includes(oldPos)) label = 'O';
        else label = 'Ú';

        sourceSlot.innerHTML = `<small class="text-muted">${label}</small>`;
        sourceSlot.classList.remove("occupied");

        // Aktualizace
        const targetSlotName = targetSlot.getAttribute("data-slot-name");
        updateRosterCardVisuals(rosterCard, targetSlotName);
        saveLineup(rosterCard.getAttribute("data-id"), targetSlotName, sourceSlot.getAttribute("data-slot-name"));
      }
    }

    function saveLineup(playerId, newSlot, oldSlot) {
      if (csrfToken && csrfHeader) {
        fetch('/api/lineup/move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
          body: JSON.stringify({
            playerId: playerId,
            newSlotName: newSlot,
            oldSlotName: oldSlot.replace('slot-', '')
          })
        });
      }
    }


    function updateRosterCardVisuals(card, slotName) {
      card.classList.add('is-assigned');
      card.setAttribute('data-current-slot', slotName);

      let text = "Nasazen";
      if (slotName.includes('L1')) text = "Nasazen v 1. formaci";
      if (slotName.includes('L2')) text = "Nasazen v 2. formaci";
      if (slotName === 'GK') text = "Nasazen v bráně";

      let overlay = card.querySelector('.assigned-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'assigned-overlay';
        card.appendChild(overlay);
      }
      overlay.innerText = text;
    }

    function isPositionValid(playerPos, slotPos) {
      if (slotPos === 'GK' || slotPos === 'G') return playerPos === 'G';
      if (slotPos === 'LD' || slotPos === 'RD' || slotPos === 'D') return playerPos === 'D';
      if (['LW', 'RW', 'C'].includes(slotPos)) return playerPos !== 'D' && playerPos !== 'G';
      return false;
    }

    function removePlayer(btn) {
      const token = btn.closest('.ice-player-token');
      const slot = token.closest('.player-slot');
      const slotName = slot.getAttribute("data-slot-name");
      const generalPos = slot.getAttribute("data-position");
      const line = slotName.includes('L1') ? '1' : '2';

      const rosterId = token.getAttribute("data-roster-id");
      const rosterCard = document.getElementById(rosterId);
      if (rosterCard) {
        rosterCard.classList.remove('is-assigned');
        rosterCard.removeAttribute('data-current-slot');
        const overlay = rosterCard.querySelector('.assigned-overlay');
        if (overlay) overlay.remove();
      }

      let label = "";
      if (generalPos === 'GK') label = 'G';
      else if (['LD', 'RD', 'D'].includes(generalPos)) label = 'O';
      else label = 'Ú';

      slot.innerHTML = `<small class="text-muted">${label}</small>`;
      slot.classList.remove("occupied");

      if (csrfToken && csrfHeader) {
        fetch('/api/lineup/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
          body: JSON.stringify({ slotName: slotName })
        });
      }
    }

    function removePlayerFromSlot(slot) {
      const btn = slot.querySelector(".remove-btn");
      if (btn) removePlayer(btn);
    }
  </script>

</body>

</html>