<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>M≈Øj T√Ωm - Sestava</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/rink.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container-fluid mt-4"> <div class="d-flex justify-content-between align-items-center mb-3 px-4">
  <h2>üèí Mana≈æer Sestavy</h2>
  <div>
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" name="line" id="line1" autocomplete="off" checked onclick="switchLine(1)">
      <label class="btn btn-outline-primary" for="line1">1. Formace</label>

      <input type="radio" class="btn-check" name="line" id="line2" autocomplete="off" onclick="switchLine(2)">
      <label class="btn btn-outline-primary" for="line2">2. Formace</label>
    </div>
    <a href="/leaderboard" class="btn btn-outline-secondary ms-3">Zpƒõt na ≈Ωeb≈ô√≠ƒçek</a>
  </div>
</div>

  <div class="row px-4">

    <div class="col-lg-8">
      <div class="rink-container shadow relative">

        <div id="line-1-container">

          <div id="slot-L1_LW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="LW" data-slot-name="L1_LW"
               th:classappend="${lineup['L1_LW'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L1_LW'] == null}">LW 1</small>
            <div th:if="${lineup['L1_LW'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L1_LW'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L1_LW'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L1_LW'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L1_LW'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L1_C" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="C" data-slot-name="L1_C"
               th:classappend="${lineup['L1_C'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L1_C'] == null}">C 1</small>
            <div th:if="${lineup['L1_C'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L1_C'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L1_C'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L1_C'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L1_C'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L1_RW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="RW" data-slot-name="L1_RW"
               th:classappend="${lineup['L1_RW'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L1_RW'] == null}">RW 1</small>
            <div th:if="${lineup['L1_RW'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L1_RW'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L1_RW'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L1_RW'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L1_RW'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L1_LD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="LD" data-slot-name="L1_LD"
               th:classappend="${lineup['L1_LD'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L1_LD'] == null}">LD 1</small>
            <div th:if="${lineup['L1_LD'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L1_LD'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L1_LD'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L1_LD'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L1_LD'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L1_RD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="RD" data-slot-name="L1_RD"
               th:classappend="${lineup['L1_RD'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L1_RD'] == null}">RD 1</small>
            <div th:if="${lineup['L1_RD'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L1_RD'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L1_RD'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L1_RD'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L1_RD'].player.lastName}">Jm√©no</div>
            </div>
          </div>
        </div>


        <div id="line-2-container" style="display: none;">

          <div id="slot-L2_LW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="LW" data-slot-name="L2_LW"
               th:classappend="${lineup['L2_LW'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L2_LW'] == null}">LW 2</small>
            <div th:if="${lineup['L2_LW'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L2_LW'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L2_LW'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L2_LW'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L2_LW'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L2_C" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="C" data-slot-name="L2_C"
               th:classappend="${lineup['L2_C'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L2_C'] == null}">C 2</small>
            <div th:if="${lineup['L2_C'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L2_C'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L2_C'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L2_C'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L2_C'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L2_RW" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="RW" data-slot-name="L2_RW"
               th:classappend="${lineup['L2_RW'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L2_RW'] == null}">RW 2</small>
            <div th:if="${lineup['L2_RW'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L2_RW'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L2_RW'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L2_RW'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L2_RW'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L2_LD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="LD" data-slot-name="L2_LD"
               th:classappend="${lineup['L2_LD'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L2_LD'] == null}">LD 2</small>
            <div th:if="${lineup['L2_LD'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L2_LD'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L2_LD'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L2_LD'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L2_LD'].player.lastName}">Jm√©no</div>
            </div>
          </div>

          <div id="slot-L2_RD" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
               data-position="RD" data-slot-name="L2_RD"
               th:classappend="${lineup['L2_RD'] != null} ? 'occupied' : ''">

            <small class="text-muted" th:if="${lineup['L2_RD'] == null}">RD 2</small>
            <div th:if="${lineup['L2_RD'] != null}" class="ice-player-token"
                 th:id="'ice-token-' + ${lineup['L2_RD'].player.id}"
                 th:data-roster-id="'roster-player-' + ${lineup['L2_RD'].player.id}">
              <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
              <img th:src="${lineup['L2_RD'].player.headshotUrl}"
                   class="ice-player-img"
                   onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
              <div class="ice-player-name" th:text="${lineup['L2_RD'].player.lastName}">Jm√©no</div>
            </div>
          </div>
        </div>


        <div id="slot-GK" class="player-slot" ondrop="drop(event)" ondragover="allowDrop(event)"
             data-position="GK" data-slot-name="GK"
             th:classappend="${lineup['GK'] != null} ? 'occupied' : ''">

          <small class="text-muted" th:if="${lineup['GK'] == null}">GK</small>
          <div th:if="${lineup['GK'] != null}" class="ice-player-token"
               th:id="'ice-token-' + ${lineup['GK'].player.id}"
               th:data-roster-id="'roster-player-' + ${lineup['GK'].player.id}">
            <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
            <img th:src="${lineup['GK'].player.headshotUrl}"
                 class="ice-player-img"
                 onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
            <div class="ice-player-name" th:text="${lineup['GK'].player.lastName}">Jm√©no</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow h-100">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">St≈ô√≠daƒçka</h5>
        </div>
        <div class="card-body roster-list p-2">

          <div th:each="player : ${team.players}"
               class="roster-card-modern"
               draggable="true"
               ondragstart="drag(event)"
               th:id="'roster-player-' + ${player.id}"


          th:classappend="${activePlayerSlots.containsKey(player.id)} ? 'is-assigned' : ''"


          th:data-current-slot="${activePlayerSlots.get(player.id)}"
          th:data-id="${player.id}"
          th:data-name="${player.lastName}"
          th:data-pos="${player.position}"
          th:data-img="${player.headshotUrl}">

          <div class="assigned-overlay" th:if="${activePlayerSlots.containsKey(player.id)}">
            <span th:if="${#strings.contains(activePlayerSlots.get(player.id), 'L1')}">Nasazen v 1. formaci</span>
            <span th:if="${#strings.contains(activePlayerSlots.get(player.id), 'L2')}">Nasazen v 2. formaci</span>
            <span th:if="${activePlayerSlots.get(player.id) == 'GK'}">Nasazen v br√°nƒõ</span>
          </div>

          <div class="player-info-left">
            <img th:src="${player.headshotUrl}"
                 alt="Foto"
                 class="player-img-small"
                 onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
            <div class="player-details">
              <h6 th:text="${player.firstName.charAt(0) + '. ' + player.lastName}">Jm√©no</h6>
              <div class="player-subtext">
                <span th:text="${player.teamName}">T√Ωm</span> ‚Ä¢
                <span th:text="${player.position}"
                      th:class="${player.position == 'G'} ? 'text-warning' : 'text-primary'">POS</span>
              </div>
            </div>
          </div>

          <div class="player-stats-right">

            <div class="stat-box">
              <span class="stat-value" th:text="${player.seasonGoals}">0</span>
              <span class="stat-label">G</span>
            </div>

            <div class="stat-box">
              <span class="stat-value" th:text="${player.seasonAssists}">0</span>
              <span class="stat-label">A</span>
            </div>

            <div class="stat-box primary">
              <span class="stat-value" th:text="${player.seasonPoints}">0</span>
              <span class="stat-label">B</span>
            </div>

          </div>
        </div>

        </div>
            </div>
          </div>
          </div>

          <div th:if="${team.players.empty}" class="text-center mt-5 text-muted">
            <p>Nem√°≈° ≈æ√°dn√© hr√°ƒçe.</p>
            <a href="/players" class="btn btn-primary btn-sm">J√≠t na Draft</a>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // Naƒçten√≠ CSRF token≈Ø (aby fungovalo ukl√°d√°n√≠)
  const csrfTokenElement = document.querySelector('meta[name="_csrf"]');
  const csrfHeaderElement = document.querySelector('meta[name="_csrf_header"]');

  const csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : null;
  const csrfHeader = csrfHeaderElement ? csrfHeaderElement.getAttribute('content') : null;

  // P≈ôep√≠n√°n√≠ formac√≠
  function switchLine(lineNumber) {
    const line1 = document.getElementById('line-1-container');
    const line2 = document.getElementById('line-2-container');

    if (lineNumber === 1) {
      line1.style.display = 'block';
      line2.style.display = 'none';
    } else {
      line1.style.display = 'none';
      line2.style.display = 'block';
    }
  }

  function allowDrop(ev) {
    ev.preventDefault(); // NUTN√â: Bez tohoto drop nefunguje!
  }

  function drag(ev) {
    const card = ev.target.closest('.roster-card-modern'); // Najdeme hlavn√≠ kartu

    ev.dataTransfer.setData("id", card.getAttribute("data-id"));
    ev.dataTransfer.setData("name", card.getAttribute("data-name"));
    ev.dataTransfer.setData("pos", card.getAttribute("data-pos"));
    ev.dataTransfer.setData("img", card.getAttribute("data-img"));
    ev.dataTransfer.setData("elementId", card.id);

    console.log("T√°hnu hr√°ƒçe: " + card.getAttribute("data-name"));
  }

  function drop(ev) {
    ev.preventDefault();
    var slot = ev.target.closest('.player-slot');
    if (!slot) return;

    const playerId = ev.dataTransfer.getData("id");
    const rosterElementId = ev.dataTransfer.getData("elementId");
    const rosterCard = document.getElementById(rosterElementId);

    // Naƒçteme kam chceme j√≠t
    const targetSlotName = slot.getAttribute("data-slot-name");
    const targetGeneralPos = slot.getAttribute("data-position");

    // Naƒçteme, kde hr√°ƒç PR√ÅVƒö TEƒé je (z atributu na kartƒõ ve st≈ô√≠daƒçce)
    const currentSlotName = rosterCard.getAttribute("data-current-slot");

    // --- 1. Validace Pozice ---
    const playerPos = ev.dataTransfer.getData("pos");
    if (!isPositionValid(playerPos, targetGeneralPos)) {
      alert("Tento hr√°ƒç nem≈Ø≈æe hr√°t na pozici " + targetGeneralPos);
      return;
    }

    // --- 2. Logika p≈ôesunu mezi formacemi ---
    if (currentSlotName) {
      // Hr√°ƒç u≈æ je nasazen√Ω. Zjist√≠me kde.
      const isLine1 = currentSlotName.includes('L1');
      const targetIsLine1 = targetSlotName.includes('L1');

      // Pokud se ho sna≈æ√≠me d√°t na stejn√© m√≠sto, nic nedƒõl√°me
      if (currentSlotName === targetSlotName) return;

      // Dotaz na zmƒõnu formace
      let message = "";
      if (isLine1 && !targetIsLine1) message = "Hr√°ƒç je v 1. formaci. Chcete ho p≈ôesunout do 2. formace?";
      else if (!isLine1 && targetIsLine1) message = "Hr√°ƒç je v 2. formaci. Chcete ho p≈ôesunout do 1. formace?";
      else message = "Opravdu chcete hr√°ƒçe p≈ôesunout na jinou pozici?"; // V r√°mci jedn√© lajny

      if (!confirm(message)) {
        return; // U≈æivatel dal Storno
      }

      // Pokud potvrdil, mus√≠me ho NEJD≈ò√çV smazat ze star√©ho slotu
      // 1. Najdeme star√Ω slot na ledƒõ (pokud je viditeln√Ω) a vyƒçist√≠me ho
      // Pozn√°mka: Proto≈æe m√°me ID slot≈Ø jako 'slot-L1_LW', m≈Ø≈æeme ho naj√≠t
      const oldSlotElement = document.getElementById('slot-' + currentSlotName);
      if (oldSlotElement) {
        // Vizu√°ln√≠ vyƒçi≈°tƒõn√≠ star√©ho slotu
        const generalPos = oldSlotElement.getAttribute("data-position");
        oldSlotElement.innerHTML = `<small class="text-muted">${generalPos}</small>`;
        oldSlotElement.classList.remove("occupied");
      }

      // 2. API vol√°n√≠ pro smaz√°n√≠ star√© pozice
      if (csrfToken && csrfHeader) {
        fetch('/api/lineup/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
          body: JSON.stringify({ slotName: currentSlotName })
        });
      }
    }

    // --- 3. Vlo≈æen√≠ na nov√© m√≠sto (Standardn√≠ Drop) ---

    // Vyhozen√≠ hr√°ƒçe, pokud je c√≠lov√Ω slot obsazen√Ω
    if (slot.classList.contains("occupied")) {
      removePlayerFromSlot(slot);
    }

    // Vykreslen√≠ tokenu
    const playerName = ev.dataTransfer.getData("name");
    const playerImg = ev.dataTransfer.getData("img");

    slot.innerHTML = `
            <div class="ice-player-token" id="ice-token-${playerId}" data-roster-id="${rosterElementId}">
                <button class="remove-btn" onclick="removePlayer(this)">√ó</button>
                <img src="${playerImg}" class="ice-player-img" onerror="this.onerror=null; this.src='https://assets.nhle.com/mugs/nhl/default-skater.png';">
                <div class="ice-player-name">${playerName}</div>
            </div>
        `;
    slot.classList.add("occupied");

    // --- 4. Aktualizace Karty na St≈ô√≠daƒçce ---
    updateRosterCardVisuals(rosterCard, targetSlotName);

    // --- 5. Ulo≈æen√≠ nov√©ho stavu ---
    if (csrfToken && csrfHeader) {
      fetch('/api/lineup/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
        body: JSON.stringify({ playerId: playerId, slotName: targetSlotName })
      });
    }
  }

  // Funkce pro vizu√°ln√≠ √∫pravu st≈ô√≠daƒçky (Za≈°ednut√≠ + Text)
  function updateRosterCardVisuals(card, slotName) {
    card.classList.add('is-assigned');
    card.setAttribute('data-current-slot', slotName); // Ulo≈æ√≠me si, kde teƒè je

    // Vytvo≈ôen√≠ textu
    let text = "Nasazen";
    if (slotName.includes('L1')) text = "Nasazen v 1. formaci";
    if (slotName.includes('L2')) text = "Nasazen v 2. formaci";
    if (slotName === 'GK') text = "Nasazen v br√°nƒõ";

    // Vlo≈æen√≠ overlay divu (pokud tam nen√≠)
    let overlay = card.querySelector('.assigned-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'assigned-overlay';
      card.appendChild(overlay);
    }
    overlay.innerText = text;
  }

  function isPositionValid(playerPos, slotPos) {
    if (slotPos === 'GK' || slotPos === 'G') return playerPos === 'G';
    if (slotPos === 'LD' || slotPos === 'RD' || slotPos === 'D') return playerPos === 'D';
    if (['LW', 'RW', 'C'].includes(slotPos)) return playerPos !== 'D' && playerPos !== 'G';
    return false;
  }

  // Upraven√° funkce Remove
  function removePlayer(btn) {
    const token = btn.closest('.ice-player-token');
    const slot = token.closest('.player-slot');
    const slotName = slot.getAttribute("data-slot-name");
    const generalPos = slot.getAttribute("data-position");

    // Reset karty na st≈ô√≠daƒçce
    const rosterId = token.getAttribute("data-roster-id");
    const rosterCard = document.getElementById(rosterId);
    if (rosterCard) {
      rosterCard.classList.remove('is-assigned');
      rosterCard.removeAttribute('data-current-slot');

      // Odstranƒõn√≠ overlay textu
      const overlay = rosterCard.querySelector('.assigned-overlay');
      if (overlay) overlay.remove();
    }

    // Vyƒçi≈°tƒõn√≠ slotu
    slot.innerHTML = `<small class="text-muted">${generalPos}</small>`;
    slot.classList.remove("occupied");

    // API Remove
    if (csrfToken && csrfHeader) {
      fetch('/api/lineup/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
        body: JSON.stringify({ slotName: slotName })
      });
    }
  }

  function removePlayerFromSlot(slot) {
    const btn = slot.querySelector(".remove-btn");
    if(btn) removePlayer(btn);
  }
</script>

</body>
</html>